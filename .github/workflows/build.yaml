name: Build EOPF container images

on: 
  workflow_dispatch:
  push:
    paths:
      - 'eopf-dask/**'
      - 'eopf-jupyterlab/**'
      - 'eopf-zarr-driver/**'

jobs:
  lock:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          micromamba-version: "latest"

      - name: Create lockenv
        run: micromamba create -n lockenv

      - name: Install conda-lock
        run: micromamba install -y -n lockenv -c conda-forge conda-lock

      - name: Generate conda lock file
        run: micromamba run -n lockenv conda-lock lock -f eopf-jupyterlab/environment.yml -p linux-64 -c conda-forge

      - name: Upload lock file
        uses: actions/upload-artifact@v4
        with:
          name: conda-lock
          path: conda-lock.yml
        
  build-jupyterlab-image:
    needs: ["lock"]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download lock file
        uses: actions/download-artifact@v5
        with:
          name: conda-lock

      - name: Display structure of downloaded files
        run: ls -r
        
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
# Log in to EOPF Container Registry with retry logic
      - name: Log in to Harbor Registry
        env:
          HARBOR_USER: ${{ secrets.HARBOR_ROBOT_USER }}
          HARBOR_PWD: ${{ secrets.HARBOR_ROBOT_PWD }}
          DOCKER_CLIENT_TIMEOUT: 300
          COMPOSE_HTTP_TIMEOUT: 300
        run: |
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if timeout 120 bash -c 'echo "$HARBOR_PWD" | docker login harbor.user.eopf.eodc.eu --username "$HARBOR_USER" --password-stdin'; then
              echo "Login successful!"
              exit 0
            else
              echo "Login failed (attempt $attempt)"
              if [ $attempt -lt $max_attempts ]; then
                sleep 5
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "Failed to login after $max_attempts attempts"
          exit 1
        timeout-minutes: 15

      # Build and push image with buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            
      - name: Build and push multi-platform image
        env:
          DOCKER_CLIENT_TIMEOUT: 600
          COMPOSE_HTTP_TIMEOUT: 600
        run: |
          SHOULD_PUSH="${{ github.ref == 'refs/heads/main' && github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}"
          
          if [ "$SHOULD_PUSH" = "true" ]; then
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --push \
              --tag harbor.user.eopf.eodc.eu/jupyterdask/eopf-jupyterlab:latest \
              --file eopf-jupyterlab/eopf-jupyterlab.dockerfile \
              .
          else
            echo "Skipping push - not on main branch or not a push/workflow_dispatch event"
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --tag harbor.user.eopf.eodc.eu/jupyterdask/eopf-jupyterlab:latest \
              --file eopf-jupyterlab/eopf-jupyterlab.dockerfile \
              .
          fi
        timeout-minutes: 60


  build-dask-image:
    needs: ["lock"]
    runs-on: ubuntu-latest
    steps:
          
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download lock file
        uses: actions/download-artifact@v5
        with:
          name: conda-lock

      - name: Display structure of downloaded files
        run: ls -r
        
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

# Log in to EOPF Container Registry with retry logic
      - name: Log in to Harbor Registry
        env:
          HARBOR_USER: ${{ secrets.HARBOR_ROBOT_USER }}
          HARBOR_PWD: ${{ secrets.HARBOR_ROBOT_PWD }}
          DOCKER_CLIENT_TIMEOUT: 300
          COMPOSE_HTTP_TIMEOUT: 300
        run: |
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if timeout 120 bash -c 'echo "$HARBOR_PWD" | docker login harbor.user.eopf.eodc.eu --username "$HARBOR_USER" --password-stdin'; then
              echo "Login successful!"
              exit 0
            else
              echo "Login failed (attempt $attempt)"
              if [ $attempt -lt $max_attempts ]; then
                sleep 5
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "Failed to login after $max_attempts attempts"
          exit 1
        timeout-minutes: 15

      # Build and push image with buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            
      - name: Build and push multi-platform image
        env:
          DOCKER_CLIENT_TIMEOUT: 600
          COMPOSE_HTTP_TIMEOUT: 600
        run: |
          SHOULD_PUSH="${{ github.ref == 'refs/heads/main' && github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}"
          
          if [ "$SHOULD_PUSH" = "true" ]; then
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --push \
              --tag harbor.user.eopf.eodc.eu/jupyterdask/eopf-dask:latest \
              --file eopf-dask/eopf-dask.dockerfile \
              .
          else
            echo "Skipping push - not on main branch or not a push/workflow_dispatch event"
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --tag harbor.user.eopf.eodc.eu/jupyterdask/eopf-dask:latest \
              --file eopf-dask/eopf-dask.dockerfile \
              .
          fi
        timeout-minutes: 60

  build-zarr-driver-image:
    runs-on: ubuntu-latest
    steps:
      # Check out the code from the repository
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

# Log in to EOPF Container Registry with retry logic
      - name: Log in to Harbor Registry
        env:
          HARBOR_USER: ${{ secrets.HARBOR_ROBOT_USER }}
          HARBOR_PWD: ${{ secrets.HARBOR_ROBOT_PWD }}
          DOCKER_CLIENT_TIMEOUT: 300
          COMPOSE_HTTP_TIMEOUT: 300
        run: |
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if timeout 120 bash -c 'echo "$HARBOR_PWD" | docker login harbor.user.eopf.eodc.eu --username "$HARBOR_USER" --password-stdin'; then
              echo "Login successful!"
              exit 0
            else
              echo "Login failed (attempt $attempt)"
              if [ $attempt -lt $max_attempts ]; then
                sleep 5
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "Failed to login after $max_attempts attempts"
          exit 1
        timeout-minutes: 15

      # Build and push image with buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            
      - name: Build and push multi-platform image
        env:
          DOCKER_CLIENT_TIMEOUT: 600
          COMPOSE_HTTP_TIMEOUT: 600
        run: |
          SHOULD_PUSH="${{ github.ref == 'refs/heads/main' && github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}"
          
          if [ "$SHOULD_PUSH" = "true" ]; then
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --push \
              --tag harbor.user.eopf.eodc.eu/jupyterdask/eopf-zarr-driver:latest \
              --file eopf-zarr-driver/eopf-zarr-driver.dockerfile \
              .
          else
            echo "Skipping push - not on main branch or not a push/workflow_dispatch event"
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --tag harbor.user.eopf.eodc.eu/jupyterdask/eopf-zarr-driver:latest \
              --file eopf-zarr-driver/eopf-zarr-driver.dockerfile \
              .
          fi
        timeout-minutes: 60
